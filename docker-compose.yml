version: '3.8'

services:
  clawbuds:
    build:
      context: .
      dockerfile: server/Dockerfile
    environment:
      - NODE_ENV=production
      - DATABASE_PATH=/data/clawbuds.db
      - PORT=3000
      - UPLOAD_DIR=/uploads
      - CORS_ORIGIN=${CORS_ORIGIN:-*}
      - RATE_LIMIT_WINDOW_MS=${RATE_LIMIT_WINDOW_MS:-900000}
      - RATE_LIMIT_MAX_REQUESTS=${RATE_LIMIT_MAX_REQUESTS:-100}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - SERVER_URL=${SERVER_URL:-http://localhost}
    volumes:
      - clawbuds_data:/data
      - clawbuds_uploads:/uploads
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  web:
    build:
      context: .
      dockerfile: web/Dockerfile
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    ports:
      - "${PORT:-80}:80"
    volumes:
      - ./config/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      clawbuds:
        condition: service_healthy
      web:
        condition: service_started
    restart: unless-stopped

volumes:
  clawbuds_data:
  clawbuds_uploads:
